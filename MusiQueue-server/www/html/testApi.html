<!DOCTYPE html>
<div id="output"></div>
<script src="jquery-3.1.1.min.js"></script>
<style type="text/css">
	.bad{
		color: #900;
	}

	.good{
		color: #090;
	}

	.good a,
	.bad a{
		color: inherit;
		text-decoration: none;
	}

	.indent{
		padding-left: 15px;
	}

	pre{
		display: inline;
	}
</style>
<script>
var numErrors = 0;

// for testing an endpoint that should work
function testEndpoint(url, params) {
    var response = $.ajax({
        type: "POST",
        url: url,
        async: false,
        data: params,
        dataType: 'json'
    }).responseJSON;

    var href = url + '?pretty&' + $.param(params);

    if(response.error) {
    	document.getElementById('output').innerHTML +=
    		"<div class='bad indent'><a href='"
    		+href
    		+"'>Error: <pre>"
    		+url
    		+' '
    		+JSON.stringify(params)
    		+"</pre> - <pre>"
    		+response.errorCode
    		+' ('
    		+response.errorMessage
    		+")</pre></a></div>";
    	numErrors++;
    }else{
    	document.getElementById('output').innerHTML += "<div class='good indent'><a href='"+href+"'>No error: <pre>"+url+' '+JSON.stringify(params)+"</pre></a></div>";
    }
    return response;
}

// for testing if an endpoint gives the correct error message
function testEndpointError(url, params, errorCode) {
    var response = $.ajax({
        type: "POST",
        url: url,
        async: false,
        data: params,
        dataType: 'json'
    }).responseJSON;
    if(!response.error) {
    	document.getElementById('output').innerHTML += "<div class='bad indent'>No error - expected <pre>'"+errorCode+"'</pre>: <pre>"+url+' '+JSON.stringify(params)+"</pre></div>";
    	numErrors++;
    }else if(response.errorCode == errorCode){
    	document.getElementById('output').innerHTML += "<div class='good indent'>Correct error: <pre>"+url+' '+JSON.stringify(params)+"</pre> - <pre>"+response.errorCode+"</pre></div>";
    }else{
    	document.getElementById('output').innerHTML += "<div class='bad indent'>Unexpected error - expected <pre>'"+errorCode+"'</pre>: <pre>"+url+' '+JSON.stringify(params)+"</pre> - <pre>"+response.errorCode+"</pre></div>";
    	numErrors++;
    }
    return response;
}

function message(m) {
	document.getElementById('output').innerHTML += "<div>"+m+"</div>";
}

function error(m) {
	document.getElementById('output').innerHTML += "<div class='bad indent'>"+m+"</div>";
    numErrors++;
}

function success(m) {
	document.getElementById('output').innerHTML += "<div class='good indent'>"+m+"</div>";
}

var ts = +(new Date());
var hubName1 = 'testHub_'+ts;
var hubName2 = 'testHub2_'+ts;
var phoneId1 = 'testPhone_'+ts;
var phoneId2 = 'testPhone2_'+ts;
var phoneId3 = 'testPhone3_'+ts;
var username = 'testUser_'+ts;
var username2 = 'testUser2_'+ts;
var username3 = 'testUser3_'+ts;
var songId = 'jofNR_WkoCE';
var songTitle = 'Test Song '+ts;
var songId2 = 'song2';
var songTitle2 = 'Test Song 2 '+ts;
var hubId, s2Id, songs;


var actions = [
	r => message("Testing User 1 creating a hub with no pin"),
	r => hubId = testEndpoint('api/createHub.php', {
		hubName: hubName1,
		phoneId: phoneId1,
		username: username
	}).result.hub_id,

	r => message("Testing user 2 joining hub with wrong name"),
	r => testEndpointError('api/joinHub.php', {
			hubName: hubName1 + 'wrong',
			phoneId: phoneId2,
			username: username2
		}, 'HUB_NOT_FOUND'),

	r => message("Testing user 2 joining hub"),
	r => testEndpoint('api/joinHub.php', {
			hubName: hubName1,
			phoneId: phoneId2,
			username: username2
		}),

	r => message("Testing user 2 adding song"),
	r => testEndpoint('api/addSong.php', {
			hubId: hubId,
			phoneId: phoneId2,
			songId: songId2,
			songTitle: songTitle2
		}),

	r => message("Testing user 2 adding another song"),
	r => testEndpoint('api/addSong.php', {
			hubId: hubId,
			phoneId: phoneId2,
			songId: songId,
			songTitle: songTitle
		}),

	r => message("Testing user 3 adding song"),
	r => testEndpointError('api/addSong.php', {
			hubId: hubId,
			phoneId: phoneId3,
			songId: songId,
			songTitle: songTitle
		}, "USER_NOT_CONNECTED"),

	r => message("Testing user 1 voting on song 2"),
	r => s2Id = testEndpoint('api/hubSongList.php', {
			hubId: hubId,
			phoneId: phoneId1
		}).result[1].id,
	r => testEndpoint('api/voteUpSong.php', {
			hubId: hubId,
			phoneId: phoneId1,
			songId: s2Id,
		}),
	r => testEndpoint('api/voteUpSong.php', {
			hubId: hubId,
			phoneId: phoneId1,
			songId: s2Id,
		}),
	r => testEndpoint('api/voteDownSong.php', {
			hubId: hubId,
			phoneId: phoneId1,
			songId: s2Id,
		}),

	r => message("Testing user 2 listing songs"),
	r => songs = testEndpoint('api/hubSongList.php', {
			hubId: hubId,
			phoneId: phoneId2
		}).result,
	r => {
			if(songs.length != 2) {
				error("song listing incorrect - wrong number of songs");
				error(JSON.stringify(songs));
			}else if(songs[0].song_id != songId || songs[0].song_title != songTitle) {
				error("song listing incorrect - song 1 wrong");
				error(JSON.stringify(songs));
			}else if(songs[0].up_votes != 2 || songs[0].down_votes != 1) {
				error("song listing incorrect - song 1 has the wrong vote totals");
			}else{
				success("song listing correct");
			}
		},

	r => message("Testing user 3 listing songs"),
	r => testEndpointError('api/hubSongList.php', {
			hubId: hubId,
			phoneId: phoneId3
		}, "USER_NOT_CONNECTED"),

	r => message("Testing removing song by incorrect user"),
	r => testEndpointError('api/removeSong.php', {
			hubId: hubId,
			phoneId: phoneId3,
			songId: s2Id
		}, "NOT_HUB_CREATOR"),

	r => message("Testing removing song by hub creator"),
	r => testEndpoint('api/removeSong.php', {
			hubId: hubId,
			phoneId: phoneId1,
			songId: s2Id
		}),
	r => songs = testEndpoint('api/hubSongList.php', {
			hubId: hubId,
			phoneId: phoneId2
		}).result,
	r => {
			if(songs.length != 1) {
				error("song listing incorrect - wrong number of songs");
				error(JSON.stringify(songs));
			}else{
				success("song listing correct");
			}
		},

	r => message("Testing removing song that should not exist"),
	r => testEndpointError('api/removeSong.php', {
		hubId: hubId,
		phoneId: phoneId1,
		songId: s2Id
	}, "SONG_NOT_FOUND"),


	r => message("Testing user 3 creating hub with same name"),
	r => testEndpointError('api/createHub.php', {
		hubName: hubName1,
		phoneId: phoneId3,
		username: username3
	}, 'HUB_NAME_TAKEN'),

	r => message("Testing user 2 closing the hub"),
	r => testEndpointError('api/closeHub.php', {
		hubId: hubId,
		phoneId: phoneId2,
	}, 'NOT_HUB_CREATOR'),

	r => message("Testing user 1 closing the hub"),
	r => testEndpoint("api/closeHub.php", {
		hubId: hubId,
		phoneId: phoneId1
	}),

	r => message("Testing user 3 joining a closed hub"),
	r => testEndpointError('api/joinHub.php', {
		hubName: hubName1,
		phoneId: phoneId3,
		username: username3
	}, "HUB_CLOSED"),

	r => message("Testing user 2 adding song"),
	r => testEndpointError('api/addSong.php', {
		hubId: hubId,
		phoneId: phoneId2,
		songId: songId2,
		songTitle: songTitle2
	}, "HUB_CLOSED"),

	r => message("Testing User 1 opening the hub again"),
	r => testEndpoint('api/createHub.php', {
		hubName: hubName1,
		phoneId: phoneId1,
		username: 'new username',
		hubPin: '1234'
	}),

	r => message("Testing user 3 joing hub with changed pin"),
	r => testEndpointError('api/joinHub.php', {
		hubName: hubName1,
		phoneId: phoneId3,
		username: username3,
		hubPin: '0000'
	}, "HUB_PIN_WRONG"),


	r => message("Testing user 1 creating hub with pin"),
	r => hubId = testEndpoint('api/createHub.php', {
		hubName: hubName2,
		phoneId: phoneId1,
		username: username,
		hubPin: '1234'
	}).result.hub_id,

	r => message("Testing user 2 joining hub with pin"),
	r => testEndpoint('api/joinHub.php', {
		hubName: hubName2,
		phoneId: phoneId2,
		username: username2,
		hubPin: '1234'
	}),

	r => message("Testing user 3 joining hub without pin"),
	r => testEndpointError('api/joinHub.php', {
		hubName: hubName2,
		phoneId: phoneId3,
		username: username3
	}, 'HUB_PIN_WRONG'),

	r => message("Testing user 3 joining hub with wrong pin"),
	r => testEndpointError('api/joinHub.php', {
		hubName: hubName2,
		phoneId: phoneId3,
		username: username3,
		hubPin: '0000'
	}, 'HUB_PIN_WRONG'),

	r => {
			message("<h2>Results</h2>");
			if(numErrors) {
				error(numErrors + " errors found!");
			}else{
				success("No errors!");
			}
		}
].reverse();

// do the actions
function doActions(actions) {
	actions.pop()();
	window.scrollTo(0,document.body.scrollHeight);
	if(actions.length)
		setTimeout(a => doActions(actions), 0)
}
doActions(actions);

</script>
